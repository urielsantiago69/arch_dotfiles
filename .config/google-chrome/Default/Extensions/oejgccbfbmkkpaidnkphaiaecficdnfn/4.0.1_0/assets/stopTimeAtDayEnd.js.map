{"version":3,"file":"stopTimeAtDayEnd.js","sources":["../../../src/lib/stopTimeAtDayEnd.ts"],"sourcesContent":["import { DateTime } from 'luxon';\nimport * as Browser from 'webextension-polyfill';\nimport * as timeEntriesApi from '@src/background/_internal/timeEntry';\nimport { stopRunningTimeEntry } from './timeEntries';\n\nconst ALARM_ID = 'track-stop-at-day-end';\n\nconst handleAlarm = async () => {\n  const timeEntriesData = await timeEntriesApi.fetch();\n\n  const runningTimeEntry = Object.values(timeEntriesData).find(\n    te => te?.duration < 0\n  );\n\n  if (runningTimeEntry) {\n    void stopRunningTimeEntry(runningTimeEntry, null).then(() => {\n      setTimeout(() => {\n        void Browser.runtime.sendMessage({\n          type: 'updateTEs',\n        });\n      }, 500);\n    });\n  }\n};\n\nexport const createStopDayEndAlarmLister = () => {\n  Browser.alarms.onAlarm.addListener(alarm => {\n    if (alarm.name === ALARM_ID) void handleAlarm();\n  });\n};\n\nexport const configureStopAtDayEnd = async (time: string) => {\n  let stopTime = DateTime.fromISO(time).set({ second: 0 });\n\n  if (stopTime < DateTime.now()) stopTime = stopTime.plus({ days: 1 });\n\n  const alarm = await Browser.alarms.get(ALARM_ID);\n\n  if (alarm) await Browser.alarms.clear(alarm.name);\n  Browser.alarms.create(ALARM_ID, {\n    when: stopTime.toMillis(),\n    periodInMinutes: 60 * 24,\n  });\n};\n\nexport const clearStopAtDayEndAlarm = async () => {\n  const alarm = await Browser.alarms.get(ALARM_ID);\n\n  if (alarm) await Browser.alarms.clear(alarm.name);\n};\n"],"names":["ALARM_ID","handleAlarm","timeEntriesData","timeEntriesApi.fetch","runningTimeEntry","te","stopRunningTimeEntry","Browser.runtime","createStopDayEndAlarmLister","Browser.alarms","alarm","configureStopAtDayEnd","time","stopTime","DateTime","clearStopAtDayEndAlarm"],"mappings":"yHAKA,MAAMA,EAAW,wBAEXC,EAAc,SAAY,CACxB,MAAAC,EAAkB,MAAMC,IAExBC,EAAmB,OAAO,OAAOF,CAAe,EAAE,KACtDG,IAAMA,GAAA,YAAAA,EAAI,UAAW,CAAA,EAGnBD,GACGE,EAAqBF,EAAkB,IAAI,EAAE,KAAK,IAAM,CAC3D,WAAW,IAAM,CACVG,EAAAA,QAAAA,QAAgB,YAAY,CAC/B,KAAM,WAAA,CACP,GACA,GAAG,CAAA,CACP,CAEL,EAEaC,EAA8B,IAAM,CACvCC,EAAAA,QAAAA,OAAO,QAAQ,YAAqBC,GAAA,CACtCA,EAAM,OAASV,GAAeC,EAAY,CAAA,CAC/C,CACH,EAEaU,EAAwB,MAAOC,GAAiB,CACvD,IAAAC,EAAWC,EAAS,QAAQF,CAAI,EAAE,IAAI,CAAE,OAAQ,CAAA,CAAG,EAEnDC,EAAWC,EAAS,IAAI,IAAGD,EAAWA,EAAS,KAAK,CAAE,KAAM,CAAG,CAAA,GAEnE,MAAMH,EAAQ,MAAMD,EAAAA,QAAAA,OAAe,IAAIT,CAAQ,EAE3CU,GAAO,MAAMD,iBAAe,MAAMC,EAAM,IAAI,EACxCD,EAAA,QAAA,OAAO,OAAOT,EAAU,CAC9B,KAAMa,EAAS,SAAS,EACxB,gBAAiB,GAAK,EAAA,CACvB,CACH,EAEaE,EAAyB,SAAY,CAChD,MAAML,EAAQ,MAAMD,EAAAA,QAAAA,OAAe,IAAIT,CAAQ,EAE3CU,GAAO,MAAMD,iBAAe,MAAMC,EAAM,IAAI,CAClD"}